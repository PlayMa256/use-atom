!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("use-context-selector")):"function"==typeof define&&define.amd?define(["exports","react","use-context-selector"],t):t((e=e||self).useAtom={},e.react,e.useContextSelector)}(this,function(e,t,n){var r="default"in t?t.default:t;function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var o=new Proxy({},{get:function(){throw new Error("Please use <Provider>")},apply:function(){throw new Error("Please use <Provider>")}}),a={values:new Map,dependents:new Map},i=n.createContext(o),s=n.createContext(o),l=function(e){var n=e.children,o=t.useReducer(function(e,t){var n,r,o,a=u({},e),i=!1,s=!0,c=function(e){e.forEach(function(e){var t=e.atom,n=e.dependent,r=a.dependents.get(t)||new Set;if(!r.has(n)){var u=new Map(a.dependents).set(t,r.add(n));a.dependents=u,i=!0}})},f=function e(t){var n,r=[],u=t.get({get:function(e){e!==t&&r.push({atom:e,dependent:t});var n=a.values.get(e);return n?n.value:e.default}});if(u instanceof Promise){var o=a.values.get(t),i=o?o.value:t.default;n={promise:u.then(function(u){try{l({type:"ADD_DEPENDENTS",deps:r});var o=r.map(function(e){var t;return null==(t=a.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e}),i=function(){if(o.length>0)return Promise.resolve(Promise.all(o).then(function(){try{var r=e(t);return n.value=r.value,Promise.resolve(r.promise).then(function(){})}catch(e){return Promise.reject(e)}})).then(function(){});n.promise=null,n.value=u}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),value:i}}else{c(r);var s=r.map(function(e){var t;return null==(t=a.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e});n=s.length>0?{promise:Promise.all(s).then(function(){try{var r=e(t);return n.value=r.value,Promise.resolve(r.promise).then(function(){})}catch(e){return Promise.reject(e)}}),value:u}:{promise:null,value:u}}return n},v=function e(t){var n=a.dependents.get(t)||new Set;if(0!==n.size){var r=new Map(a.values);n.forEach(function(t){var n=f(t);n.promise?n.promise.then(function(){l({type:"UPDATE_DEPENDENTS",atom:t})}):e(t),r.set(t,n)}),a.values=r,i=!0}},p=function e(t,n){var r=a.values.get(t),u=r?r.value:t.default;if(u!==n)if(s){a.values=new Map(a.values).set(t,{promise:null,value:n});var o,c=t.set({get:function(e){var t=a.values.get(e);return t?t.value:e.default},set:function(n,r){n!==t&&e(n,r)}},n);o=c instanceof Promise?{promise:c.then(function(){try{var e=f(t);return o.value=e.value,Promise.resolve(e.promise).then(function(){o.value=e.value})}catch(e){return Promise.reject(e)}}),value:u}:f(t);var p=new Map(a.values).set(t,o);a.values=p,i=!0,v(t)}else l({type:"SET_VALUE",atom:t,value:n})};switch(t.type){case"INIT_ATOM":!function(e){if(!a.values.has(e)){var t=f(e),n=new Map(a.values).set(e,t);a.values=n,i=!0}}(t.atom);break;case"UPDATE_DEPENDENTS":v(t.atom);break;case"SET_VALUE":p(t.atom,t.value);break;case"UPDATE_VALUE":r=t.update,o=a.values.get(n=t.atom),p(n,"function"==typeof r?r(o?o.value:n.default):r);break;case"ADD_DEPENDENTS":c(t.deps);break;default:throw new Error("unexpected action type")}return s=!1,i?a:e},a),l=o[1];return r.createElement(i.Provider,{value:l},r.createElement(s.Provider,{value:o[0]},n))};function c(e){var t=u({},e,{get:function(e){return e.get(t)},set:function(e,n){return e.set(t,n)}});return t}function f(e){return u({},e,{default:null})}function v(e){var r=n.useContext(i),u=n.useContextSelector(s,t.useCallback(function(t){return t.values.get(e)},[e])),o=t.useCallback(function(t){if(!function(e){return!!e.set}(e))throw new Error("not writable atom");r({type:"UPDATE_VALUE",atom:e,update:t})},[e,r]);if(t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u&&u.promise)throw u.promise;return[void 0===u?e.default:u.value,o]}function p(e){var r=n.useContext(i),u=n.useContextSelector(s,t.useCallback(function(t){return t.values.get(e)},[e]));if(t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u&&u.promise)throw u.promise;return void 0===u?e.default:u.value}function m(e){var r=n.useContext(i),u=t.useCallback(function(t){r({type:"UPDATE_VALUE",atom:e,update:t})},[e,r]);return t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u}e.Provider=l,e.RecoilRoot=l,e.atom=function(e){return c(e)},e.createAtom=c,e.deriveAtom=f,e.selector=function(e){return f(e)},e.useAtom=v,e.useAtomUpdate=m,e.useAtomValue=p,e.useRecoilState=v,e.useRecoilValue=p,e.useSetRecoilState=m});
//# sourceMappingURL=index.umd.js.map
