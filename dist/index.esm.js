import e,{useReducer as t,useCallback as n,useEffect as r}from"react";import{createContext as a,useContext as u,useContextSelector as o}from"use-context-selector";function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var s=new Proxy({},{get:function(){throw new Error("Please use <Provider>")},apply:function(){throw new Error("Please use <Provider>")}}),l={values:new Map,dependents:new Map},v=a(s),c=a(s),f=function(n){var r=n.children,a=t(function(e,t){var n=i({},e),r=!1,a=!0,o=function(e){e.forEach(function(e){var t=e.atom,a=e.dependent,u=n.dependents.get(t)||new Set;if(!u.has(a)){var o=new Map(n.dependents).set(t,u.add(a));n.dependents=o,r=!0}})},s=function e(t){var r,a=[],i=t.get({get:function(e){e!==t&&a.push({atom:e,dependent:t});var r=n.values.get(e);return r?r.value:e.default}});if(i instanceof Promise){var s=n.values.get(t),l=s?s.value:t.default;r={promise:i.then(function(o){try{u({type:"ADD_DEPENDENTS",deps:a});var i=a.map(function(e){var t;return null==(t=n.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e}),s=function(){if(i.length>0)return Promise.resolve(Promise.all(i).then(function(){try{var n=e(t);return r.value=n.value,Promise.resolve(n.promise).then(function(){})}catch(e){return Promise.reject(e)}})).then(function(){});r.promise=null,r.value=o}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),value:l}}else{o(a);var v=a.map(function(e){var t;return null==(t=n.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e});r=v.length>0?{promise:Promise.all(v).then(function(){try{var n=e(t);return r.value=n.value,Promise.resolve(n.promise).then(function(){})}catch(e){return Promise.reject(e)}}),value:i}:{promise:null,value:i}}return r},l=function e(t){var a=n.dependents.get(t)||new Set;if(0!==a.size){var o=new Map(n.values);a.forEach(function(t){var n=s(t);n.promise?n.promise.then(function(){u({type:"UPDATE_DEPENDENTS",atom:t})}):e(t),o.set(t,n)}),n.values=o,r=!0}},v=function e(t,o){var i=n.values.get(t),v=i?i.value:t.default;if(v!==o)if(a){n.values=new Map(n.values).set(t,{promise:null,value:o});var c,f=t.set({get:function(e){var t=n.values.get(e);return t?t.value:e.default},set:function(n,r){n!==t&&e(n,r)}},o);c=f instanceof Promise?{promise:f.then(function(){try{var e=s(t);return c.value=e.value,Promise.resolve(e.promise).then(function(){c.value=e.value})}catch(e){return Promise.reject(e)}}),value:v}:s(t);var p=new Map(n.values).set(t,c);n.values=p,r=!0,l(t)}else u({type:"SET_VALUE",atom:t,value:o})};switch(t.type){case"INIT_ATOM":!function(e){if(!n.values.has(e)){var t=s(e),a=new Map(n.values).set(e,t);n.values=a,r=!0}}(t.atom);break;case"UPDATE_DEPENDENTS":l(t.atom);break;case"SET_VALUE":v(t.atom,t.value);break;case"UPDATE_VALUE":!function(e,t){var r=n.values.get(e),a="function"==typeof t?t(r?r.value:e.default):t;v(e,a)}(t.atom,t.update);break;case"ADD_DEPENDENTS":o(t.deps);break;default:throw new Error("unexpected action type")}return a=!1,r?n:e},l),u=a[1];return e.createElement(v.Provider,{value:u},e.createElement(c.Provider,{value:a[0]},r))};function p(e){var t=i({},e,{get:function(e){return e.get(t)},set:function(e,n){return e.set(t,n)}});return t}function m(e){return i({},e,{default:null})}function d(e){var t=u(v),a=o(c,n(function(t){return t.values.get(e)},[e])),i=n(function(n){if(!function(e){return!!e.set}(e))throw new Error("not writable atom");t({type:"UPDATE_VALUE",atom:e,update:n})},[e,t]);if(r(function(){t({type:"INIT_ATOM",atom:e})},[t,e]),a&&a.promise)throw a.promise;return[void 0===a?e.default:a.value,i]}function h(e){var t=u(v),a=o(c,n(function(t){return t.values.get(e)},[e]));if(r(function(){t({type:"INIT_ATOM",atom:e})},[t,e]),a&&a.promise)throw a.promise;return void 0===a?e.default:a.value}function E(e){var t=u(v),a=n(function(n){t({type:"UPDATE_VALUE",atom:e,update:n})},[e,t]);return r(function(){t({type:"INIT_ATOM",atom:e})},[t,e]),a}function P(e){return p(e)}function w(e){return m(e)}export{f as Provider,f as RecoilRoot,P as atom,p as createAtom,m as deriveAtom,w as selector,d as useAtom,E as useAtomUpdate,h as useAtomValue,d as useRecoilState,h as useRecoilValue,E as useSetRecoilState};
//# sourceMappingURL=index.esm.js.map
