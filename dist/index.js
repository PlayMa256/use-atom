var e,t=require("react"),r=(e=t)&&"object"==typeof e&&"default"in e?e.default:e,n=require("use-context-selector");function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var o=new Proxy({},{get:function(){throw new Error("Please use <Provider>")},apply:function(){throw new Error("Please use <Provider>")}}),a={values:new Map,dependents:new Map},s=n.createContext(o),i=n.createContext(o),l=function(e){var n=e.children,o=t.useReducer(function(e,t){var r,n,o,a=u({},e),s=!1,i=!0,c=function(e){e.forEach(function(e){var t=e.atom,r=e.dependent,n=a.dependents.get(t)||new Set;if(!n.has(r)){var u=new Map(a.dependents).set(t,n.add(r));a.dependents=u,s=!0}})},v=function e(t){var r,n=[],u=t.get({get:function(e){e!==t&&n.push({atom:e,dependent:t});var r=a.values.get(e);return r?r.value:e.default}});if(u instanceof Promise){var o=a.values.get(t),s=o?o.value:t.default;r={promise:u.then(function(u){try{l({type:"ADD_DEPENDENTS",deps:n});var o=n.map(function(e){var t;return null==(t=a.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e}),s=function(){if(o.length>0)return Promise.resolve(Promise.all(o).then(function(){try{var n=e(t);return r.value=n.value,Promise.resolve(n.promise).then(function(){})}catch(e){return Promise.reject(e)}})).then(function(){});r.promise=null,r.value=u}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),value:s}}else{c(n);var i=n.map(function(e){var t;return null==(t=a.values.get(e.atom))?void 0:t.promise}).filter(function(e){return!!e});r=i.length>0?{promise:Promise.all(i).then(function(){try{var n=e(t);return r.value=n.value,Promise.resolve(n.promise).then(function(){})}catch(e){return Promise.reject(e)}}),value:u}:{promise:null,value:u}}return r},f=function e(t){var r=a.dependents.get(t)||new Set;if(0!==r.size){var n=new Map(a.values);r.forEach(function(t){var r=v(t);r.promise?r.promise.then(function(){l({type:"UPDATE_DEPENDENTS",atom:t})}):e(t),n.set(t,r)}),a.values=n,s=!0}},p=function e(t,r){var n=a.values.get(t),u=n?n.value:t.default;if(u!==r)if(i){a.values=new Map(a.values).set(t,{promise:null,value:r});var o,c=t.set({get:function(e){var t=a.values.get(e);return t?t.value:e.default},set:function(r,n){r!==t&&e(r,n)}},r);o=c instanceof Promise?{promise:c.then(function(){try{var e=v(t);return o.value=e.value,Promise.resolve(e.promise).then(function(){o.value=e.value})}catch(e){return Promise.reject(e)}}),value:u}:v(t);var p=new Map(a.values).set(t,o);a.values=p,s=!0,f(t)}else l({type:"SET_VALUE",atom:t,value:r})};switch(t.type){case"INIT_ATOM":!function(e){if(!a.values.has(e)){var t=v(e),r=new Map(a.values).set(e,t);a.values=r,s=!0}}(t.atom);break;case"UPDATE_DEPENDENTS":f(t.atom);break;case"SET_VALUE":p(t.atom,t.value);break;case"UPDATE_VALUE":n=t.update,o=a.values.get(r=t.atom),p(r,"function"==typeof n?n(o?o.value:r.default):n);break;case"ADD_DEPENDENTS":c(t.deps);break;default:throw new Error("unexpected action type")}return i=!1,s?a:e},a),l=o[1];return r.createElement(s.Provider,{value:l},r.createElement(i.Provider,{value:o[0]},n))};function c(e){var t=u({},e,{get:function(e){return e.get(t)},set:function(e,r){return e.set(t,r)}});return t}function v(e){return u({},e,{default:null})}function f(e){var r=n.useContext(s),u=n.useContextSelector(i,t.useCallback(function(t){return t.values.get(e)},[e])),o=t.useCallback(function(t){if(!function(e){return!!e.set}(e))throw new Error("not writable atom");r({type:"UPDATE_VALUE",atom:e,update:t})},[e,r]);if(t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u&&u.promise)throw u.promise;return[void 0===u?e.default:u.value,o]}function p(e){var r=n.useContext(s),u=n.useContextSelector(i,t.useCallback(function(t){return t.values.get(e)},[e]));if(t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u&&u.promise)throw u.promise;return void 0===u?e.default:u.value}function m(e){var r=n.useContext(s),u=t.useCallback(function(t){r({type:"UPDATE_VALUE",atom:e,update:t})},[e,r]);return t.useEffect(function(){r({type:"INIT_ATOM",atom:e})},[r,e]),u}exports.Provider=l,exports.RecoilRoot=l,exports.atom=function(e){return c(e)},exports.createAtom=c,exports.deriveAtom=v,exports.selector=function(e){return v(e)},exports.useAtom=f,exports.useAtomUpdate=m,exports.useAtomValue=p,exports.useRecoilState=f,exports.useRecoilValue=p,exports.useSetRecoilState=m;
//# sourceMappingURL=index.js.map
